# Maintainer: Antoine Martin <antoine.martin@protonmail.com>
pkgname=dam
pkgver=0.2.6-75-g6f4b82b
pkgrel=0
pkgdesc="A digital audio manager built very specifically for my git-annex backed music collection"
url="https://github.com/ayakael/dam"
arch="noarch"
license="GPL3"
depends="bash shntool gawk sed grep bc git-annex cuetools findutils coreutils git ffmpeg imagemagick flac p7zip"
makedepends="bash coreutils findutils gawk git"
source="$pkgname-$pkgver.tar.gz"
_giturl="https://github.com/ayakael/dam"
_gittag="$pkgver"
builddir="$srcdir/$pkgname"
options="!check"

snapshot() {
	mkdir -p "$srcdir"
	cd "${SRCDEST:-$srcdir}"
	if ! [ -d $pkgname.git ]; then
		git clone $_giturl $pkgname.git || return 1
		cd $pkgname.git
	else
		cd $pkgname.git
		git fetch || return 1
	fi

	echo "Checking out"
	git checkout $_gittag
	echo "Repo archive"
	git archive --prefix="$pkgname/" -o dam.tar --format "tar" $_gittag

	echo "Submod update"
	git submodule update --init
	cd bunc
	echo "Submod archive"
	git archive --prefix="$pkgname/bunc/" --format="tar" -o "../bunc.tar" "master"
	cd ..
    
   
	tar --concatenate --file dam.tar bunc.tar
	gzip dam.tar -c > "$SRCDEST"/$pkgname-$pkgver.tar.gz
	ln -s "$SRCDEST"/$pkgname-$pkgver.tar.gz "$startdir"/$pkgname-$pkgver.tar.gz 
}

build() {
	cd "$builddir"
	./build.sh "VERSION=${pkgver}"
}

package() {
	cd "$builddir"
	install -Dm755 ./dam "$pkgdir"/usr/bin/dam
}
sha512sums="22244e80a2b846d6900c8c1eeae2893083e33319759b7a6ba3b48acc4baeb98c536e6b3e5a7821ebb887a52e77d40ccd45b074919b4639470fa47ab1728027e8  dam-0.2.6-75-g6f4b82b.tar.gz"
