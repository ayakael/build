 
# Maintainer: Maxime Gauduin <alucryd@archlinux.org>
# Contributor: Kristian Mosegaard <kristian@mosen.me>
# Contributor: Max Liebkies <mail@maxliebkies.de>
# Contributor: Krzysztof Bogacki <krzysztof.bogacki@leancode.pl>

_pkgbase=dotnet
pkgname=dotnet-sdk
pkgdesc='The .NET Core SDK'
pkgver=5.0.6
pkgrel=0
arch='x86_64'
url=https://www.microsoft.com/net/core
license='MIT'
makedepends='
  bash
  clang
  cmake
  git
  icu-dev
  inetutils-syslogd
  krb5-dev
  libgit2-dev
  libunwind-dev
  libxml2-dev
  libxml2-utils
  lldb-dev
  llvm10-dev
  lttng-ust-dev
  nodejs
  openssl-dev
  zlib-dev
'
#depends='
#  icu-libs
#  krb5-libs
#  libgcc
#  #libgdiplus
#  libintl
#  libssl1.1
#  libstdc++zlib
#'
subpackages="$_pkgbase-host:host $_pkgbase-runtime:runtime aspnet-runtime:aspnet_runtime:noarch netstandard-targeting-pack:netstandard_targeting_pack:noarch $_pkgbase-targeting-pack:targeting_pack aspnet-targeting-pack:aspnet_targeting_pack:noarch" 
_gittag=a8f12771179965da9f48646ded87068d379563b9
_giturl=https://github.com/dotnet/source-build
source="
  $_pkgbase-$pkgver.tar.gz
  dotnet.sh
  9999-runtime-link-order.patch
  9999-sdk-telemetry-optout.patch
  9999-Fix-build-on-Alpine-edge-45352.patch
  9999-Fix-last-version-digit-present-on-alpine-non-portable.patch
  9999-Fixed-problematic-version-of-ApplicationInsights-dot.patch
  9999-fixed-net40-location.patch
  https://dotnet.microsoft.com/download/dotnet/scripts/v1/dotnet-install.sh
"
builddir="$srcdir/$_pkgbase"

snapshot() {
	mkdir -p "$srcdir"
	cd "${srcdir}"
	if ! [ -d $pkgname.git ]; then
		git clone $_giturl $pkgname.git || return 1
		cd $pkgname.git
	else
		cd $pkgname.git
		git fetch || return 1
	fi

	echo "Checking out"
	git checkout $_gittag
	echo "Repo archive"
	git archive --prefix="$_pkgbase/" -o $_pkgbase.tar --format "tar" $_gittag

	gzip $pkgname.tar -c > "$SRCDEST"/$_pkgbase-$pkgver.tar.gz
	ln -s "$SRCDEST"/$_pkgbase-$pkgver.tar.gz "$startdir"/$_pkgbase-$pkgver.tar.gz 
}


prepare() {
  cd "${builddir}"
  msg "Settings up dotnet bootstrap"
  mkdir runtime
  mkdir bootstrap

  bash $srcdir/dotnet-install.sh -c Current --install-dir ./
  bash $srcdir/dotnet-install.sh -c 3.1 --install-dir . --runtime dotnet

  patch -p1 < "${srcdir}"/9999-Fixed-problematic-version-of-ApplicationInsights-dot.patch

  [ -d patches/runtime ] || mkdir patches/runtime
  cp "$srcdir"/9999-runtime-link-order.patch patches/runtime/.
  cp "$srcdir"/9999-Fix-build-on-Alpine-edge-45352.patch patches/runtime/.
  cp "$srcdir"/9999-Fix-last-version-digit-present-on-alpine-non-portable.patch patches/runtime/.
  [ -d patches/sdk ] || mkdir patches/sdk
  cp "$srcdir"/9999-sdk-telemetry-optout.patch patches/sdk/.
  [ -d patches/application-insights ] || mkdir patches/application-insights
  cp "$srcdir"/9999-fixed-net40-location.patch patches/application-insights/.

  # disable warnings
  sed -i 's|skiptests|skiptests ignorewarnings|' repos/runtime.common.props

  # To simulate git directory for DARC
  mkdir -p .git/objects .git/refs
  echo "${_gittag}" > .git/HEAD
  touch .git/patched-refs .git/index

# TODO Why does /var/build/build/apk/v3.13/main/dotnet-sdk/src/dotnet/artifacts/src/sdk.b8025906f7463b6e477893c81238dc7003b353a3/artifacts/bin/redist/Release/dotnet/artifacts/src/sdk.b8025906f7463b6e477893c81238dc7003b353a3/artifacts/bin/redist/Release/dotnet/artifacts/src/ApplicationInsights-dotnet.53b80940842204f78708a538628288ff5d741a1d/src/Core/Managed/Net40/Utils.cs not appear? It's in Shared, though.
#   cp Shared/* net45/. -R 
# 	cp Shared/* netstandard1.3/. -R


}

pkgver() {
  cd "$builddir"

  local _runtimever=$(xmllint --xpath "//Dependency[@Name='Microsoft.NETCore.App.Runtime.win-x64']/@Version" eng/Version.Details.xml | cut -d '=' -f 2 | sed 's/^"//; s/"$//')
  local _sdkver=$(xmllint --xpath "//Dependency[@Name='Microsoft.NET.Sdk']/@Version" eng/Version.Details.xml | cut -d '=' -f 2 | sed 's/^"//; s/"$//; s/-rtm.*//; s/-servicing.*//')

  echo "${_runtimever}.sdk${_sdkver##*.}"
}

build() {
  cd "$builddir"

  export SOURCE_BUILD_SKIP_SUBMODULE_CHECK=1

  ./build.sh \
    --with-sdk ../dotnet \
    /p:ArchiveDownloadedPackages=true \
    /p:ContinueOnPrebuiltBaselineError=true \
    /p:SkipPortableRuntimeBuild=true \
    /p:SkipPrebuiltEnforcement=true \
    /p:UseSystemLibraries=true \
    /p:UseSystemLibunwind=true
}

package() {
  depends='
    dotnet-runtime
    dotnet-targeting-pack
    musl
    libgcc
    netstandard-targeting-pack
    aspnet-targeting-pack
  '

  cd "$builddir"/artifacts/x64/Release

  install -dm 755 "$pkgdir"/usr/share/dotnet "$pkgdir"/usr/share/licenses
  bsdtar -xf dotnet-sdk-*.tar.gz -C "${pkgdir}"/usr/share/dotnet/ --no-same-owner sdk templates
  ln -s dotnet-host "${pkgdir}"/usr/share/licenses/dotnet-sdk
}


host() {
  pkgdesc='A generic driver for the .NET Core Command Line Interface'
  depends='
    gcc
    musl
  '

  cd $builddir/artifacts/x64/Release

  install -dm 755 "$subpkgdir"/etc/profile.d "$subpkgdir"/usr/bin "$subpkgdir"/usr/lib "$subpkgdir"/usr/share/dotnet "$subpkgdir"/usr/share/licenses/dotnet-host 

  bsdtar -xf dotnet-sdk-*.tar.gz -C "${subpkgdir}"/usr/share/dotnet/ --no-same-owner dotnet host
  bsdtar -xf dotnet-sdk-*.tar.gz -C "${subpkgdir}"/usr/share/licenses/dotnet-host/ --no-same-owner LICENSE.txt ThirdPartyNotices.txt
  ln -s /usr/share/dotnet/dotnet "${subpkgdir}"/usr/bin/dotnet
  ln -s /usr/share/dotnet/host/fxr/${pkgver}/libhostfxr.so "${subpkgdir}"/usr/lib/libhostfxr.so
  install -Dm 644 "${srcdir}"/dotnet.sh -t "${subpkgdir}"/etc/profile.d/
}

runtime() {
  pkgdesc='The .NET Core runtime'
  makedepends='
    icu-dev
    krb5-dev
    libunwind-dev
    zlib-dev
    openssl-dev
    '
  depends='
    dotnet-host
    libgcc
    musl
    icu
    krdb5-libs
    libunwind
    zlib
    openssl
  '

  cd "$builddir"/artifacts/x64/Release

  install -dm 755 "$subpkgdir"/usr/share/dotnet "$subpkgdir"/usr/share/licenses
  bsdtar -xf dotnet-sdk-*.tar.gz -C "${subpkgdir}"/usr/share/dotnet/ --no-same-owner shared/Microsoft.NETCore.App
  ln -s dotnet-host "${subpkgdir}"/usr/share/licenses/dotnet-runtime
}

aspnet_runtime() {
  pkgdesc='The ASP.NET Core runtime'
  depends='dotnet-runtime'

  cd "$builddir"/artifacts/x64/Release

  install -dm 755 "$subpkgdir"/usr/share/dotnet "$subpkgdir"/usr/share/licenses
  bsdtar -xf dotnet-sdk-*.tar.gz -C "${subpkgdir}"/usr/share/dotnet/ --no-same-owner shared/Microsoft.AspNetCore.App
  ln -s dotnet-host "${subpkgdir}"/usr/share/licenses/aspnet-runtime
}

netstandard_targeting_pack() {
  pkgdesc='The .NET Standard targeting pack'

  cd "$builddir"/artifacts/x64/Release

  install -dm 755 "$subpkgdir"/usr/share/dotnet "$subpkgdir"/usr/share/licenses
  bsdtar -xf dotnet-sdk-*.tar.gz -C "${subpkgdir}"/usr/share/dotnet/ --no-same-owner packs/NETStandard.Library.Ref
  ln -s dotnet-host "${subpkgdir}"/usr/share/licenses/netstandard-targeting-pack
}

targeting_pack() {
  pkgdesc='The .NET Core targeting pack'
  depends='netstandard-targeting-pack'

  cd "$builddir"/artifacts/x64/Release

  install -dm 755 "$subpkgdir"/usr/share/dotnet "$subpkgdir"/usr/share/licenses
  bsdtar -xf dotnet-sdk-*.tar.gz -C "${subpkgdir}"/usr/share/dotnet/ --no-same-owner packs/Microsoft.NETCore.App.Host.alpine.3.13-x64 packs/Microsoft.NETCore.App.Ref
  ln -s dotnet-host "${subpkgdir}"/usr/share/licenses/dotnet-targeting-pack
}

aspnet_targeting_pack() {
  pkgdesc='The ASP.NET Core targeting pack'
  depends='dotnet-targeting-pack'

  cd "$builddir"/artifacts/x64/Release

  install -dm 755 "$subpkgdir"/usr/share/dotnet "$subpkgdir"/usr/share/licenses
  bsdtar -xf dotnet-sdk-*.tar.gz -C "${subpkgdir}"/usr/share/dotnet/ --no-same-owner packs/Microsoft.AspNetCore.App.Ref
  ln -s dotnet-host "${subpkgdir}"/usr/share/licenses/aspnet-targeting-pack
}

# vim: ts=2 sw=2 et:
sha512sums="c53a173cdd48d2e25905cd1f15c930965df8edff311ad267144b1fcc5a9cc06e2e42c7e630f12c5c75cfff19488a9217d9fabb88ac112a0f6feed5c62ea65024  dotnet-5.0.6.tar.gz
e61b9e3e5a2305646a616d598378230c9755c5dd5363692cc363f8f4add3807563c324dd86f3a7ae9d358c82d730608e7b293935a2b6c81c0c0f62d752a0a1cf  dotnet.sh
ad57d02371d351106e043fa104e31afbb0d6799e7ce0ea1a26f585abbfbab7bcba734c7e70491c4af5bfbed965a9ed3235cf4bc1019f504baf482518193b10a7  9999-runtime-link-order.patch
c96700138ea919c169c3a394f1bf9548c7f86b1ba42b193d6e7bb0a1e2bd6f7f202befbc61246a8720181cd40e1f7fa36a6c208eb19b03a23e21994136fb2507  9999-sdk-telemetry-optout.patch
025b297e81130e6f46dfa755cfd35c3756ef148a48adcc99511d95b1ec8eeede3561f31bbdf6b16cb294da3642298c9353ba07e9728c9c60fe9c3e0f2e2b4ed4  9999-Fix-build-on-Alpine-edge-45352.patch
944461da9ed50d536195ab3572b15fdfa74713344a4ca5e31bed627f09fbf328dd0d1f66599553d474e766cacdba7146c701180810383245fcdce1aba39bfef3  9999-Fix-last-version-digit-present-on-alpine-non-portable.patch
58a3e93e5fb6247569c291f86db127cbbc6cc6842eaf0973c2a211d4806f08dcabd9781b7da567088d820a337d58d6375230ade991dcc77e170266675c4a97e5  9999-Fixed-problematic-version-of-ApplicationInsights-dot.patch
0469d571d0f7634d3794761f04e1cbff9d27d642d134a11a13560574280e5cab6f366eb8820e61a449eca99470fdea8d9f6a7d97b633059b2fe25257ed1579e6  9999-fixed-net40-location.patch
ecab4809e617e9cd30940b1c1a700e16b37b5974c850a60da7f1a25bf81516850e4533ef39d2d8786381e0e4e325d3b53fbb2377ecaa6c0813bb00fc1c92b784  dotnet-install.sh"
